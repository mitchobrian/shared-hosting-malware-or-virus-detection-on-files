<?php

require_once __DIR__ . '/../vendor/scr34m/php-malware-scanner/scan.php';

require __DIR__ . '/functions.php';

// stop app while running
if (file_exists(LOCKFILE_AND_PATH)) {
    // if app runs longer then 24hours it seems to be crashed
    if ((time() - filemtime(LOCKFILE_AND_PATH) >= 60 * 60 * 24)) {
        unlink(LOCKFILE_AND_PATH);
    } else {
        print 'present lock file';
        exit(0);
    }
}
// write lock file
file_put_contents(LOCKFILE_AND_PATH, time());
// create hash db
$db = new SQLite3(DB_NAME_AND_PATH);
$db->exec("CREATE TABLE IF NOT EXISTS files(
   id INTEGER PRIMARY KEY AUTOINCREMENT, 
   full_path TEXT NOT NULL DEFAULT '',
   hash_key TEXT NOT NULL DEFAULT '')");

// output array
$allFiles = array();
$newFiles = array();
$affectedFiles = array();
$affectedFilesIds = array();
$changedFiles = array();

// scan all dirs
getNextFile(FOLDER);
$scanner = new MalwareScanner(false);
$scanner->initializePatterns();
$scanner->setFlagHideOk(true);
$scanner->setFlagHideErr(true);
$scanner->setFlagScanEverything(true);
$scanner->setFlagBase64(false);
$scanner->setFlagNoStop(true);
$scanner->setFlagDisableStats(true);

// save hash and check hash
foreach ($allFiles as $key => $val) {
    $stop = false;
    foreach ($whiteList as $white) if (strpos($key, $white) !== false) $stop = true;
    if ($stop) continue;
    $statement = $db->prepare('SELECT * FROM files WHERE full_path = :full_path;');
    $statement->bindValue(':full_path', $key);
    $result = $statement->execute();
    if ($row = $result->fetchArray()) {
        if ($row['hash_key'] != $val) {
            if ($scanner->scan($key)) {
                $affectedFiles[$key] = $row['hash_key'];
            }
            $changedFiles[$key] = $row['hash_key'];
            $affectedFilesIds[$key] = $row['id'];
        }
    } else {
        // new files array
        $newFiles[$key] = $val;
        $db->exec("INSERT INTO files(full_path, hash_key) VALUES('$key', '$val')");
        $lastid = $db->lastInsertRowid();
        if ($scanner->scan($key)) {
            $affectedFilesIds[$key] = $lastid;
        }
    }
}

$htmlAffectedFiles = "";
if (count($affectedFiles) > 0) {
    foreach ($affectedFiles as $key => $val) {
        $fileName = explode("/", $key);
        $fileName = $fileName[count($fileName) - 1];
        $htmlAffectedFiles .= "<span style=padding:2px;><a title='$key' style='cursor:help;'><u>$fileName</u></a> - <a href='" . URL . "/?id=" . $affectedFilesIds[$key] . "&hash=$val'>update hash</a></span><br />";
    }
}

$htmlChangedFiles = "";
if (count($changedFiles) > 0) {
    foreach ($changedFiles as $key => $val) {
        $fileName = explode("/", $key);
        $fileName = $fileName[count($fileName) - 1];
        $htmlChangedFiles .= "<span style=padding:2px;><a title='$key' style='cursor:help;'><u>$fileName</u></a> - <a href='" . URL . "/?id=" . $affectedFilesIds[$key] . "&hash=$val'>update hash</a></span><br />";
    }
}

$htmlNewFiles = "";
if (count($newFiles) > 0) {
    foreach ($newFiles as $key => $val) {
        $fileName = explode("/", $key);
        $fileName = $fileName[count($fileName) - 2] . "/" . $fileName[count($fileName) - 1];
        $htmlNewFiles .= "<span style=padding:2px;><a title='$key' style='cursor:help;'><u>$fileName</u></a></span><br />";
    }
}

// write report mail 
include __DIR__ . '/template.php';
$header  = 'MIME-Version: 1.0' . "\r\n";
$header .= 'Content-type: text/html; charset=utf-8' . "\r\n";
$header .= 'Content-Transfer-Encoding: base64' . "\r\n";
//$header .= "X-Mailer: PHP " . phpversion();

mail(
    MAIL,
    'Malware Scan Report ' . PROVIDER . (count($affectedFiles) > 0 ? ' ðŸ”¥ Attention!' : ' ðŸ‘Œ'),
    base64_encode($report),
    $header
);

// release lock file for next run
unlink(LOCKFILE_AND_PATH);

/*
@todo
use Cbi\MalwareChecker\MalwareChecker;
$hash = MalwareChecker::makeHash("app.php"); // fea80f2db003d4ebc4536023814aa885;
print $hash;
var_dump(MalwareChecker::check("1d14f32d905e79aefca1b4ebc7762f5a"));
*/