<?php

require __DIR__ . '/functions.php';

// stop app while running
if (file_exists(LOCKFILE)) {
    // if app runs longer then 24hours it seems to be crashed
    if ((time() - filemtime(LOCKFILE) >= 60 * 60 * 24)) {
        unlink(LOCKFILE);
    } else {
        exit(0);
    }
}
// write lock file
file_put_contents(LOCKFILE, time());
// create hash db
$db = new SQLite3(DB_NAME);
$db->exec("CREATE TABLE IF NOT EXISTS files(
   id INTEGER PRIMARY KEY AUTOINCREMENT, 
   full_path TEXT NOT NULL DEFAULT '',
   hash_key TEXT NOT NULL DEFAULT '')");

// output array
$allFiles = array();
$newFiles = array();
$affectedFiles = array();

// scan all dirs
getNextFile(FOLDER);

// save hash and check hash
foreach ($allFiles as $key => $val) {
    $stop = false;
    foreach ($whiteList as $white) if (strpos($key, $white) !== false) $stop = true;
    if ($stop) continue;
    $statement = $db->prepare('SELECT * FROM files WHERE full_path = :full_path;');
    $statement->bindValue(':full_path', $key);
    $result = $statement->execute();
    if ($row = $result->fetchArray()) {
        if ($row['hash_key'] != $val) {
            $affectedFiles[$key] = $val;
        }
    } else {
        $newFiles[$key] = $val;
        // new files array
        $db->exec("INSERT INTO files(full_path, hash_key) VALUES('$key', '$val')");
    }
}

// write report mail 
include __DIR__ . '/template.php';
$header  = 'MIME-Version: 1.0' . "\r\n";
$header .= 'Content-type: text/html; charset=utf-8' . "\r\n";
$header .= 'Content-Transfer-Encoding: base64' . "\r\n";
//$header .= "X-Mailer: PHP " . phpversion();
mail(
    MAIL,
    'Malware Scan Report ' . PROVIDER . (count($affectedFiles) > 0 ? ' ðŸ”¥ Attention!' : ' ðŸ‘Œ'),
    base64_encode($report),
    $header
);

// release lock file for next run
unlink(LOCKFILE);

/*
@todo
use Cbi\MalwareChecker\MalwareChecker;
$hash = MalwareChecker::makeHash("app.php"); // fea80f2db003d4ebc4536023814aa885;
print $hash;
var_dump(MalwareChecker::check("1d14f32d905e79aefca1b4ebc7762f5a"));
*/