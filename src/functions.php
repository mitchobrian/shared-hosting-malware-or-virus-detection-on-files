<?php

function getNextFile($path = ".")
{
    global $allFiles, $whiteList;
    $files = scandir($path);
    foreach ($files as $file) {
        if ($file != "." && $file != "..") {
            $completePath = $path . "/" . $file;
            $stop = false;
            foreach ($whiteList as $white) if (strpos($completePath, $white) !== false) $stop = true;
            if ($stop) continue;
            if (is_dir($completePath)) {
                getNextFile($completePath);
            } else {
                $allFiles[$completePath] = md5(@file_get_contents($completePath));
            }
        }
    }
}

// https://stackoverflow.com/questions/768215/php-pretty-print-html-not-tidy
function indentContent($content, $tab = "\t")
{
    $content = preg_replace('/(>)(<)(\/*)/', "$1\n$2$3", $content); // add marker linefeeds to aid the pretty-tokeniser (adds a linefeed between all tag-end boundaries)
    $token = strtok($content, "\n"); // now indent the tags
    $result = ''; // holds formatted version as it is built
    $pad = 0; // initial indent
    $matches = array(); // returns from preg_matches()
    // scan each line and adjust indent based on opening/closing tags
    while ($token !== false && strlen($token) > 0) {
        $padPrev = $padPrev ?: $pad; // previous padding //Artis
        $token = trim($token);
        // test for the various tag states
        if (preg_match('/.+<\/\w[^>]*>$/', $token, $matches)) { // 1. open and closing tags on same line - no change
            $indent = 0;
        } elseif (preg_match('/^<\/\w/', $token, $matches)) { // 2. closing tag - outdent now
            $pad--;
            if ($indent > 0) $indent = 0;
        } elseif (preg_match('/^<\w[^>]*[^\/]>.*$/', $token, $matches)) { // 3. opening tag - don't pad this one, only subsequent tags (only if it isn't a void tag)
            foreach ($matches as $m) {
                if (preg_match('/^<(area|base|br|col|command|embed|hr|img|input|keygen|link|meta|param|source|track|wbr)/im', $m)) { // Void elements according to http://www.htmlandcsswebdesign.com/articles/voidel.php
                    $voidTag = true;
                    break;
                }
            }
            $indent = 1;
        } else { // 4. no indentation needed
            $indent = 0;
        }


        $line = str_pad($token, strlen($token) + $pad, $tab, STR_PAD_LEFT); // pad the line with the required number of leading spaces
        $result .= $line . "\n"; // add to the cumulative result, with linefeed
        $token = strtok("\n"); // get the next token
        $pad += $indent; // update the pad size for subsequent lines
        if ($voidTag) {
            $voidTag = false;
            $pad--;
        }
    }
    return $result;
}
