<?php

use Cbi\MalwareChecker\MalwareChecker;

require __DIR__ . '/vendor/autoload.php';

const FOLDER = "../";
const DB_NAME = "MALEWARE.db";

$db = new SQLite3(DB_NAME);
$db->exec("CREATE TABLE IF NOT EXISTS files(
   id INTEGER PRIMARY KEY AUTOINCREMENT, 
   full_path TEXT NOT NULL DEFAULT '',
   hash_key TEXT NOT NULL DEFAULT '')");

$whiteList = array('/node_modules', '.expo', '.cache', '.git', '/vendor', '/cache', '/tmp', DB_NAME);
$allFiles = array();
$newFiles = array();
$affectedFiles = array();

mail('malware@palmomedia.de', 'Malware START', '');
getNextFile(FOLDER);
mail('malware@palmomedia.de', 'Malware ALL FILES SCANNED', '');

foreach ($allFiles as $key => $val) {
    $stop = false;
    foreach ($whiteList as $white) if (strpos($key, $white) !== false) $stop = true;
    if ($stop) continue;
    $statement = $db->prepare('SELECT * FROM files WHERE full_path = :full_path;');
    $statement->bindValue(':full_path', $key);
    $result = $statement->execute();

    if ($row = $result->fetchArray()) {
        //echo "{$row['id']} {$row['full_path']} {$row['full_path']} \n";
        if ($row['hash_key'] != $val) {
            $affectedFiles[$key] = $val;
        }
    } else {
        $newFiles[$key] = $val;
        // new files array
        $db->exec("INSERT INTO files(full_path, hash_key) VALUES('$key', '$val')");
    }
}
mail('malware@palmomedia.de', 'Malware ALL FILES SAVED', '');

print "\n effected";
var_dump($affectedFiles);

print "\n\n new files";
var_dump($newFiles);

// report
mail('malware@palmomedia.de', 'Malware Report', "effected:\n" . print_r($affectedFiles, 1) . "\n---\n\nNew files: \n" . print_r($newFiles, 1) . "\n---\n\nAll files: \n" . print_r($allFiles, 1));

/*
$hash = MalwareChecker::makeHash("app.php"); // fea80f2db003d4ebc4536023814aa885;
print $hash;
print "\n";
var_dump(MalwareChecker::check("1d14f32d905e79aefca1b4ebc7762f5a"));
print "\n";
*/

function getNextFile($path = ".")
{
    global $allFiles, $whiteList;
    $files = scandir($path);
    foreach ($files as $file) {
        if ($file != "." && $file != "..") {
            $completePath = $path . "/" . $file;
            $stop = false;
            foreach ($whiteList as $white) if (strpos($completePath, $white) !== false) $stop = true;
            if ($stop) continue;
            if (is_dir($completePath)) {
                getNextFile($completePath);
            }
            $allFiles[$completePath] = md5(file_get_contents($completePath));
        }
    }
}
